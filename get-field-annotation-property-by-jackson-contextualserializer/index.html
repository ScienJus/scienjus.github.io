<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Jackson使用ContextualSerializer在序列化时获取字段注解的属性 · ScienJus's Blog</title><meta name="description" content="Jackson使用ContextualSerializer在序列化时获取字段注解的属性 - ScienJus"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.scienjus.com/atom.xml" title="ScienJus's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/ScienJus" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ScienJus" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Jackson使用ContextualSerializer在序列化时获取字段注解的属性</h1><div class="post-info">Feb 23, 2016</div><div class="post-content"><p>这个资料挺少了，所以记录一下。</p>
<p> 需求举例：</p>
<p> 在某一个项目中，数据库存储图片文件的路径，服务端将域名和路径拼接之后返回给客户端。例如数据库存储的路径为<code>/1.jpg</code>，服务端配置文件中配置的域名为<code>http://img.xxx.com</code>，最终返回给客户端<code>http://img.xxx.com/1.jpg</code></p>
<p> 最简单的方法是在建立 Model（返回给客户端的 JSON 对象）时，直接拼接并赋值，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class UserModel &#123;</span><br><span class="line"></span><br><span class="line">    private String avatar</span><br><span class="line"></span><br><span class="line">    public UserModel (User user) &#123;</span><br><span class="line">        this.avatar = Config.HOST_NAME + user.getAvatar;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 但是这样做过于硬编码，不易修改和维护，更好的办法是使用注解显式的声明序列化方式，在 Jackson 中就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class UserModel &#123;</span><br><span class="line"></span><br><span class="line">    @JsonSerialize (using = ImageURLSerialize.class)</span><br><span class="line">    private String avatar</span><br><span class="line"></span><br><span class="line">    public UserModel (User user) &#123;</span><br><span class="line">        this.avatar = user.getAvatar;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class ImageURLSerialize extends JsonSerializer&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void serialize (String value, JsonGenerator jgen, SerializerProvider provider) throws IOException &#123;</span><br><span class="line">        if (!StringUtils.isEmpty (value)) &#123;</span><br><span class="line">            jgen.writeString (Config.HOST_NAME + value);</span><br><span class="line">        &#125;</span><br><span class="line">        jgen.writeString (value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这样 Jackson 会使用<code>ImageURLSerialize</code>序列化<code>avatar</code>字段 ，该类实现的<code>serialize</code>方法会自动在路径前添加域名。</p>
<p> 可以进一步封装为一个独立的注解使其更容易使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Retention (RetentionPolicy.RUNTIME)</span><br><span class="line">@JacksonAnnotationsInside</span><br><span class="line">@JsonSerialize (using = ImageURLSerialize.class)</span><br><span class="line">public @interface ImageURL &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这样在 Model 类中只需要使用<code>@ImageURL</code>注解字段就可以了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class UserModel &#123;</span><br><span class="line"></span><br><span class="line">    @ImageURL</span><br><span class="line">    private String avatar</span><br><span class="line"></span><br><span class="line">    public UserModel (User user) &#123;</span><br><span class="line">        this.avatar = user.getAvatar;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 到此为止处理的都还算不错，直到有一天出现了新需求：图片服务器从本地搬到了阿里云 OSS 上。由于开通了 CDN 服务，图片可以在获取时生成缩略图了，只需要在图片链接后添加类似于<code>@100w_100h</code>的参数。</p>
<p> 在之前的基础上，最好的方法肯定是给<code>@ImageURL</code>增加一个字段标识需要附加的参数，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Retention (RetentionPolicy.RUNTIME)</span><br><span class="line">@JacksonAnnotationsInside</span><br><span class="line">@JsonSerialize (using = ImageURLSerialize.class)</span><br><span class="line">public @interface ImageURL &#123;</span><br><span class="line"></span><br><span class="line">    // 请求图片附加的参数，会追加在图片地址后面</span><br><span class="line">    String param () default &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这时候问题出现了，在<code>ImageURLSerialize</code>的<code>serialize</code>方法中根本无法获得<code>@ImageURL</code>注解，更别说获得注解中的参数了。</p>
<p> 接下来就要介绍本文的重点了，<code>ContextualSerializer</code>是 Jackson 提供的另一个序列化相关的接口，它的作用是通过字段已知的上下文信息定制<code>JsonSerializer</code>，只需要实现<code>createContextual</code>方法即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">class ImageURLSerialize extends JsonSerializer&lt;String&gt; implements ContextualSerializer &#123;</span><br><span class="line"></span><br><span class="line">    private String param;</span><br><span class="line"></span><br><span class="line">    // 必须要保留无参构造方法</span><br><span class="line">    public ImageURLSerialize () &#123;</span><br><span class="line">        this (&quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public ImageURLSerialize (String param) &#123;</span><br><span class="line">        this.param = param;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void serialize (String value, JsonGenerator jgen, SerializerProvider provider) throws IOException &#123;</span><br><span class="line">        String url = &quot;&quot;;</span><br><span class="line">        if (!StringUtils.isEmpty (value)) &#123;</span><br><span class="line">            url = Config.HOST_NAME + value;</span><br><span class="line">            if (!StringUtils.isEmpty (param)) &#123;</span><br><span class="line">                url = url + param;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        jgen.writeString (url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public JsonSerializer&lt;?&gt; createContextual (SerializerProvider serializerProvider, BeanProperty beanProperty) throws JsonMappingException &#123;</span><br><span class="line">        if (beanProperty != null) &#123; // 为空直接跳过</span><br><span class="line">            if (Objects.equals (beanProperty.getType ().getRawClass (), String.class)) &#123; // 非 String 类直接跳过</span><br><span class="line">                ImageURL imageURL = beanProperty.getAnnotation (ImageURL.class);</span><br><span class="line">                if (imageURL == null) &#123;</span><br><span class="line">                    imageURL = beanProperty.getContextAnnotation (ImageURL.class);</span><br><span class="line">                &#125;</span><br><span class="line">                if (imageURL != null) &#123; // 如果能得到注解，就将注解的 value 传入 ImageURLSerialize</span><br><span class="line">                    return new ImageURLSerialize (imageURL.value ());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return serializerProvider.findValueSerializer (beanProperty.getType (), beanProperty);</span><br><span class="line">        &#125;</span><br><span class="line">        return serializerProvider.findNullValueSerializer (beanProperty);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>createContextual</code>可以获得字段的类型以及注解。当字段为<code>String</code>类型并且拥有<code>@ImageURL</code>注解时，取出注解中的值创建定制的<code>ImageURLSerialize</code>，这样在<code>serialize</code>方法中便可以得到这个值了。<code>createContextual</code>方法只会在第一次序列化字段时调用（因为字段的上下文信息在运行期不会改变），所以不用担心影响性能。</p>
<p> 更多的使用方式可以看 <a href="https://github.com/FasterXML/jackson-databind/blob/master/src/test/java/com/fasterxml/jackson/databind/contextual/TestContextualSerialization.java" target="_blank" rel="external">Jackson 官方的测试用例</a>。</p>
</div></article></div></main><footer><div class="paginator"><a href="/wekan/" class="prev">PREV</a><a href="/try-kotlin/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'scienjus';
var disqus_identifier = 'get-field-annotation-property-by-jackson-contextualserializer/';
var disqus_title = 'Jackson使用ContextualSerializer在序列化时获取字段注解的属性';
var disqus_url = 'http://www.scienjus.com/get-field-annotation-property-by-jackson-contextualserializer/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//scienjus.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="http://www.scienjus.com">ScienJus</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?47cf199e59a26235dadf455975b8b67f";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();</script></body></html>
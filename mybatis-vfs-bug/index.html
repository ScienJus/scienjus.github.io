<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> MyBatis无法扫描Spring Boot别名的Bug · ScienJus's Blog</title><meta name="description" content="MyBatis无法扫描Spring Boot别名的Bug - ScienJus"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.scienjus.com/atom.xml" title="ScienJus's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/ScienJus" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ScienJus" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">MyBatis无法扫描Spring Boot别名的Bug</h1><div class="post-info">Mar 25, 2016</div><div class="post-content"><p>这个问题发生的原因比较复杂，主要条件有 4 个：</p>
<ol>
<li>使用 Spring Boot，并使用 Spring Boot 的 Maven 插件打包</li>
<li>使用 MyBatis（目前最新的<code>3.3.1</code>版本仍有这个问题）</li>
<li>将 Domain 配置在单独的 Jar 包中（例如 Maven 多模块）</li>
<li><p>使用<code>SqlSessionFactoryBean.setTypeAliasesPackage</code>指定包扫描 Domain</p>
<p>然后你会发现：在开发时直接使用 IDEA 执行<code>main</code>方法运行时一切正常，但是打成 Jar 包后使用<code>java -jar</code>启动时配置的 Domain 别名均会失效。</p>
<p>例如我有一个 Spring Boot 项目，其中分为三个 Maven 模块：</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">scienjus</span><br><span class="line">----scienjus-domain</span><br><span class="line">--------com.scienjus.domain.User</span><br><span class="line">----scienjus-mapper</span><br><span class="line">--------com.scienjus.mapper.UserMapper</span><br><span class="line">--------UserMapper.xml</span><br><span class="line">----scienjus-web</span><br><span class="line">--------SqlSessionFactoryConfig</span><br></pre></td></tr></table></figure>
<p> 在 SqlSessionFactoryConfig 中配置 SqlSesstionFactory：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public SqlSessionFactory sqlSessionFactory () throws Exception &#123;</span><br><span class="line">    final SqlSessionFactoryBean sqlSessionFactory = new SqlSessionFactoryBean ();</span><br><span class="line">    sqlSessionFactory.setDataSource (dataSource ());</span><br><span class="line">    // 配置别名</span><br><span class="line">    sqlSessionFactory.setTypeAliasesPackage (&quot;com.scienjus.domain&quot;);</span><br><span class="line">    return sqlSessionFactory.getObject ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 在 UserMapper.xml 使用别名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=&quot;get&quot; resultType=&quot;User&quot;&gt;</span><br><span class="line">    select * from user u where id = \#&#123;id&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<p> 开发时使用 IDEA 启动一切都会正常运行，但是如果等到运行时通过命令行启动，将会出现以下错误信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.apache.ibatis.builder.BuilderException: Error resolving class. Cause:</span><br><span class="line">org.apache.ibatis.type.TypeException: Could not resolve type alias &apos;User&apos;. Cause:</span><br><span class="line">java.lang.ClassNotFoundException: Cannot find class: User</span><br></pre></td></tr></table></figure>
<p> 这个错误的大概意思是生成 Mapper 时出错了，原因是无法识别<code>User</code>这个别名，也找不到<code>User</code>这个 class。可以看出之前配的包扫描根本没有扫描到<code>com.scienjus.domain.User</code>这个类。</p>
<p> 为了证明这点，我翻了一下 MyBatis 的源码，然后在<code>org.apache.ibatis.type.TypeAliasRegistry</code>的<code>registerAliases (String packageName, Class&gt; superType)</code>方法中发现了 MyBatis 是如何通过包名扫描别名类的。直接将这部分逻辑搬到<code>main</code>方法中执行试试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static void main (String [] args) &#123;</span><br><span class="line">    ResolverUtil resolverUtil = new ResolverUtil ();</span><br><span class="line">    resolverUtil.find (new IsA (Object.class), &quot;com.scienjus.domain&quot;);</span><br><span class="line">    Set typeSet = resolverUtil.getClasses ();</span><br><span class="line">    Iterator i$ = typeSet.iterator ();</span><br><span class="line"></span><br><span class="line">    while (i$.hasNext ()) &#123;</span><br><span class="line">        Class type = (Class) i$.next ();</span><br><span class="line">        if (!type.isAnonymousClass () &amp;&amp; !type.isInterface () &amp;&amp; !type.isMemberClass ()) &#123;</span><br><span class="line">            System.out.println (type.getName ());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 分别在 IDEA 和 Jar 中执行，会发现前者将会打印出<code>com.scienjus.domain.User</code>，后者却无任何输出结果，说明问题出在这里。</p>
<p> 既然锁定了问题出现的地方，就可以仔细看看这是如何发生的了。查看<code>ResolverUtil.find</code>方法，其通过<code>VFS.getInstance ().list (path)</code>方法获得 Class 文件，而<code>VFS.getInstance ()</code>默认情况下返回的是<code>DefaultVFS</code>，也就是说原因是这个类的<code>list</code>方法无法扫描到 Spring Boot 依赖 Jar 包中的类。</p>
<p> 再细化一下调用逻辑，就可以准备断点调试了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static void main (String [] args) throws IOException &#123;</span><br><span class="line">    DefaultVFS defaultVFS = new DefaultVFS ();</span><br><span class="line">    List children = defaultVFS.list (&quot;com/scienjus/domain&quot;);</span><br><span class="line">    for (String child : children) &#123;</span><br><span class="line">        System.out.println (child);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 断点调试使用<code>java -jar</code>启动的程序并没有想象中困难，IDEA 和 Eclipse 都内置了非常优秀的调试工具，略微介绍一下 IDEA 中的使用方法：</p>
<p> 开启 Debug 模式运行 Jar 包，并且监听一个特定的端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=y -jar scienjus-web.jar</span><br></pre></td></tr></table></figure>
<p>IDEA 端在 Run -\&gt; Edit Configurations 中创建一个 Remote 应用，填写 IP 和监听的端口号，然后启动就可以了。</p>
<p> 通过断点调试我在<code>findJarForResource</code>发现了一块比较有意思的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// If the file part of the URL is itself a URL, then that URL probably points to the JAR</span><br><span class="line">try &#123;</span><br><span class="line">  for (;;) &#123;</span><br><span class="line">    url = new URL (url.getFile ());</span><br><span class="line">    if (log.isDebugEnabled ()) &#123;</span><br><span class="line">      log.debug (&quot;Inner URL: &quot; + url);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; catch (MalformedURLException e) &#123;</span><br><span class="line">  // This will happen at some point and serves as a break in the loop</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这是一个死循环，唯有抛出<code>MalformedURLException</code>异常时才会跳出循环，根据上面的注释我们可以得知，这件事是必然发生的，且会将<code>url</code>指向一个想要的结果。对比一下两种方式运行时<code>url</code>最后的结果：</p>
<p>IDEA 中直接运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scienjus-domain/target/classes/com/scienjus/domain</span><br></pre></td></tr></table></figure>
<p> 命令行运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scienjus-web/target/scienjus-web.jar!/lib/scienjus-domain.jar!/com/scienjus/domain</span><br></pre></td></tr></table></figure>
<p> 之后将变量<code>jarUrl</code>的值赋为<code>scienjus-web/target/scienjus-web.jar!/lib/scienjus-domain.jar</code>，但是最后<code>listResources</code>方法会返回<code>null</code>。</p>
<p> 而调用这个方法时的注释则是这样说的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// First, try to find the URL of a JAR file containing the requested resource. If a JAR</span><br><span class="line">// file is found, then we&apos;ll list child resources by reading the JAR.</span><br></pre></td></tr></table></figure>
<p> 也就是说，如果扫描的文件确实在一个 Jar 包中，这个方法应该返回这个 Jar 包的 URL，于是尝试一个比较粗暴的改进：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public static void main (String [] args) throws IOException &#123;</span><br><span class="line">    DefaultVFS defaultVFS = new DefaultVFS () &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected URL findJarForResource (URL url) throws MalformedURLException &#123;</span><br><span class="line">            String urlStr = url.toString ();</span><br><span class="line">            if (urlStr.contains (&quot;jar!&quot;)) &#123;</span><br><span class="line">                return new URL (urlStr.substring (0, urlStr.lastIndexOf (&quot;jar&quot;) + &quot;jar&quot;.length ()));</span><br><span class="line">            &#125;</span><br><span class="line">            return super.findJarForResource (url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    List children = defaultVFS.list (&quot;com/scienjus/domain&quot;);</span><br><span class="line">    for (String child : children) &#123;</span><br><span class="line">        System.out.println (child);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 如果这个 URL 中含有<code>jar!</code>的标识，就直接返回这个 Jar 包的地址。我不太确定这样做是否有隐患，不过我只有在扫描 Domain 别名时会用到这个类，并且这时候是正常工作的。</p>
<p> 既然这个类可以正常工作了，只需要将它设为默认的 VFS。在 MyBatis 的 <a href="http://www.mybatis.org/mybatis-3/zh/configuration.html#properties" target="_blank" rel="external">文档</a> 中写着可以通过配置文件更改<code>vfsImpl</code>属性更换 VFS 实现类，我这里用这个配置没有效果，原因是 Spring 的配置会在 MyBatis 配置文件之前执行，所以在读取这个配置之前<code>VFS.getInstall ()</code>已经实例化了。然后我给 MyBatis 提了个 Issue，顺道还发现这个扫描不到类的 Bug 早在去年10月 就有人提出了，也早就有解决办法了，只是需要到<code>3.4.1</code>版本才会发布。</p>
<p>MyBatis 官方的解决办法首先是推荐使用 <a href="https://github.com/mybatis/mybatis-spring-boot" target="_blank" rel="external">mybatis-spring-boot</a> 的<code>1.0.1</code>版本，默认已经配置了一个兼容 Spring Boot 的 VFS 实现类。或是将 <a href="https://github.com/mybatis/mybatis-spring-boot/commit/35be747a4c4e53121e4c4c32d08418864095adf7" target="_blank" rel="external">这个实现类</a> 添加到你的项目中，并手动配置。</p>
<p> 为了不让这些瞎折腾白费，我决定将这整个过程发布出来，教各位在使用开源项目遇到 bug 时如何定（zuo）位（si），这可能也是本文的仅剩的一点价值了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/chrome-developer-tools/" class="prev">上一篇</a><a href="/wekan/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'scienjus';
var disqus_identifier = 'mybatis-vfs-bug/';
var disqus_title = 'MyBatis无法扫描Spring Boot别名的Bug';
var disqus_url = 'http://www.scienjus.com/mybatis-vfs-bug/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//scienjus.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="http://www.scienjus.com">ScienJus</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?47cf199e59a26235dadf455975b8b67f";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();</script></body></html>